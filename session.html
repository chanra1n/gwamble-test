<!DOCTYPE html>
<html>

<head>
    <title>GWAMBLE</title>
    <link rel="stylesheet" type="text/css" href="css/lib/remixicon.css">
    <link rel="stylesheet" type="text/css" href="css/lib/uikit.css">
    <link rel="stylesheet" type="text/css" href="css/lib/animate.css">
    <link rel="stylesheet" type="text/css" href="css/custom/index.css">
    <link rel="stylesheet" type="text/css" href="css/custom/session.css">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <link rel="manifest" href="https://chanra1n.github.io/gwamble-test/manifest.json">
    <link rel="apple-touch-icon" sizes="72x72" href="icon/icon-72x72.png">
    <link rel="icon" type="image/png" sizes="96x96" href="icon/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="128x128" href="icon/icon-128x128.png">
    <link rel="icon" type="image/png" sizes="144x144" href="icon/icon-144x144.png">
    <link rel="icon" type="image/png" sizes="152x152" href="icon/icon-152x152.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="384x384" href="icon/icon-384x384.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon/icon-512x512.png">
    <meta name="theme-color" content="#ffc0cb">
    <meta name="background-color" content="#ffc0cb">
    <meta name="msapplication-TileColor" content="#ffc0cb">
    <meta name="msapplication-TileImage" content="icon/icon-144x144.png">
    <meta name="msapplication-config" content="https://csclubhumboldt.org/browserconfig.xml">
    <meta name="application-name" content="gwamble">
    <meta name="apple-mobile-web-app-title" content="gwamble">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">

</head>

<body>

    <nav id="gwamble-bar" uk-navbar>
        
<button id="gwamble-close-session" onclick="closeSession()">
<i class="ri-arrow-left-s-fill"></i>
<span>Exit</span>
</button>

        <p id = "gwamble-role">
        <i class="ri-record-circle-fill"></i>
        <span>Active</span>
        </p>

        <p onclick = "UIkit.modal('#member-modal').show()" >
        <i class="ri-group-2-fill"></i>
        <span id = "gwamble-bet-member-ratio">0/0</span>
        </p>
    </nav>

    <div class="gwamble-post" id="posted-gwamble">
        <div class = "gwamble-post-header">
        <i class="ri-user-4-fill"></i>
        <span id = "gwamble-poster" >annoying-orange</span>
        </div>
        <h1 onclick = "window.location.reload(true)" id="gwamble-subject">Subject</h1>
        <br>
        
        <div class="gwamble-button-container" id = "outcome-a">
            <button id="gwamble-outcome-a">
                <span id="gwamble-outcome-a-text">Outcome A</span>
            </button>
            <span id="gwamble-outcome-a-bets" class="gwamble-bets">0</span>
        </div>

        <button onclick = "declareWinner('a')" class = "winner-button" id="gwamble-winner-a">
        Declare winner
        </button>

        <div class="gwamble-button-container" id = "outcome-b">
            <button id="gwamble-outcome-b">
                <span id="gwamble-outcome-b-text">Outcome B</span>
            </button>
            <span id="gwamble-outcome-b-bets" class="gwamble-bets">0</span>
        </div>

        <button onclick = "declareWinner('b')" class = "winner-button" id="gwamble-winner-b" style = "margin-bottom: 0px;">
        Declare winner
        </button>

        </div>


        <div class = "gwamble-bottom">
        <button onclick = "copyGwambleCode()" id = "gwamble-share-code" data-code = "888-888">888-888 <i id = "gwamble-copy-icon" class="ri-file-copy-fill"></i></button>
        <button onclick = "UIkit.modal('#qr-modal').show()" id = "gwamble-qr-code"><i class="ri-qr-code-fill"></i></button>
        </div>


        <div uk-modal id="qr-modal" onclick = "UIkit.modal('#qr-modal').hide()">
            <div class="uk-modal-dialog">
                <div id="gwamble-qr-display"></div>
        </div>

        <div uk-modal id="member-modal">
            <div class="uk-modal-dialog">
                <div id = "member-modal-list">

                </div>
                <button class="uk-button uk-button-default uk-modal-close" type="button">Close</button>
            </div>
        </div>
    

</body>
<script src="js/lib/uikit.js"></script>
<script src="js/lib/qrcode.js"></script>

<script>

var gwamble;

function initSession() {
    var session = sessionStorage.getItem('gwamble');
    if (session) {
        gwamble = JSON.parse(session);
        console.log(gwamble);
    } else {
        gwamble = {
            "subject": "no posted gwamble",
            "outcome_a": "outcome a",
            "outcome_b": "outcome b"
        }
    }

    document.getElementById('gwamble-subject').innerHTML = gwamble.subject;
    document.getElementById('gwamble-outcome-a-text').innerHTML = gwamble.outcome_a;
    document.getElementById('gwamble-outcome-b-text').innerHTML = gwamble.outcome_b;


}

window.onload = function() {
initSession();
generateQRCode();
writeToMemberModal('annoying-orange');
}

function closeSession() {
    sessionStorage.removeItem('gwamble');
    window.location.replace('index.html');
}

function copyGwambleCode() {
    var code = document.getElementById('gwamble-share-code');
    var text = code.getAttribute('data-code');
    navigator.clipboard.writeText(text);

    var icon = document.getElementById('gwamble-copy-icon');
    icon.classList.remove('ri-file-copy-fill');
    icon.classList.add('ri-check-fill');
    setTimeout(function() {
        icon.classList.remove('ri-check-fill');
        icon.classList.add('ri-file-copy-fill');
    }, 2500);
}

function generateQRCode() {
    var code = document.getElementById('gwamble-share-code');
    var text = code.innerHTML;
    var qr = new QRCode(document.getElementById("gwamble-qr-display"), {
        text: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
        width: 256,
        height: 256,
    });
}


function writeToMemberModal(username) {

    var role_button = `<button onclick = "kickMember('`+username+`')"><i class="ri-indeterminate-circle-fill kicker"></i></button>`;

    // if the username is currently written to the gwamble-poster element,
    // then update the role_button to be a different icon
    if (document.getElementById('gwamble-poster').innerHTML == username) {
        role_button = ``;
    }

    var member_item = `
    <div class = "member-item">
        <i class="ri-user-4-fill"></i>
        <span>`+username+`</span>
        `+role_button+`
    </div>
    `;

    var member_list = document.getElementById('member-modal-list');
    member_list.innerHTML += member_item;
}

function kickMember(username) {
    var member_list = document.getElementById('member-modal-list');
    var member_items = member_list.getElementsByClassName('member-item');
    for (var i = 0; i < member_items.length; i++) {
        var member = member_items[i];
        if (member.getElementsByTagName('span')[0].innerHTML == username) {
            member_list.removeChild(member);
        }
    }
}


function declareWinner(outcome) {
    var winner_post = document.getElementById('outcome-'+outcome);
    var winner_button = document.getElementById('gwamble-winner-'+outcome);
    var loser_post = document.getElementById('outcome-'+(outcome == 'a' ? 'b' : 'a'));
    var loser_button = document.getElementById('gwamble-winner-'+(outcome == 'a' ? 'b' : 'a'));

    loser_post.remove();
    loser_button.remove();

    winner_post.style.transition = "all 0.1s ease-in-out";
    winner_post.classList.add('animate__animated');
    winner_post.style.animation = "tada 1s";
    winner_button.style.marginBottom = "0px";


    document.getElementsByClassName('gwamble-bottom')[0].remove();
    document.getElementById('gwamble-bar').style.pointerEvents = "none";
    document.getElementById('gwamble-close-session').style.pointerEvents = "none";
    document.getElementById('gwamble-close-session').style.color = "#503c40";

    winner_button.innerHTML = "Settled!";
    winner_button.style.opacity = "0.5";
    winner_button.style.pointerEvents = "none";


}

</script>

</html>